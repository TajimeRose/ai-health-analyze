{% extends "base.html" %}
{% block title %}‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö AI - AI Health Analyze{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-4 text-center">‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö AI</h2>

<div class="relative z-0 bg-white shadow rounded-xl p-4 max-w-4xl mx-auto w-full">
  <div id="chat" class="h-80 overflow-y-auto border rounded p-3 mb-3 bg-gray-50 flex flex-col gap-3"></div>

  <form id="chat-form" class="flex items-center gap-3">
    <!-- ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏∞ CSS ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ -->
    <input id="msg"
           type="text"
           class="flex-1 w-full min-w-0 h-11 border rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
           placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
    <button type="submit"
            class="h-11 px-6 bg-blue-600 text-white rounded hover:bg-blue-700">
      ‡∏™‡πà‡∏á
    </button>
  </form>

  <p id="err" class="text-red-600 mt-2 hidden"></p>
</div>

<style>
  /* ‡∏Å‡∏±‡∏ô CSS ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏±‡∏ö input ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ */
  #chat-form input#msg {
    width: 100% !important;
    height: 44px !important;
  }
</style>

<script>
  const chat = document.getElementById('chat');
  const form = document.getElementById('chat-form');
  const msg  = document.getElementById('msg');
  const err  = document.getElementById('err');

  const avatars = {
    user: "{{ url_for('static', filename='img/avatar-user.svg') }}",
    ai: "{{ url_for('static', filename='img/avatar-ai.svg') }}",
    system: "{{ url_for('static', filename='img/avatar-ai.svg') }}"
  };

  function createAvatar(who) {
    const wrap = document.createElement('div');
    wrap.className = 'w-10 h-10 rounded-full border-2 border-blue-500 overflow-hidden flex-shrink-0 bg-white flex items-center justify-center';

    const role = who === 'system' ? 'ai' : who;
    const img = document.createElement('img');
    img.src = avatars[who] || avatars[role] || avatars.ai;
    img.alt = role === 'user' ? 'User avatar' : 'AI avatar';
    img.className = 'w-full h-full object-cover';
    img.onerror = () => {
      wrap.innerHTML = '';
      wrap.classList.add('text-blue-600', 'font-semibold');
      wrap.textContent = role === 'user' ? 'U' : 'AI';
      wrap.style.backgroundColor = role === 'user' ? '#1E3A8A' : '#2563EB';
    };

    wrap.appendChild(img);
    return wrap;
  }

  function addMessage(who, text) {
    const role = who === 'system' ? 'ai' : who;

    const row = document.createElement('div');
    row.className = 'w-full flex items-end gap-3';
    row.classList.add(role === 'user' ? 'justify-end' : 'justify-start');

    const bubble = document.createElement('div');
    bubble.className = 'px-4 py-2 rounded-2xl shadow max-w-[70%] whitespace-pre-wrap leading-relaxed text-white ' +
      (role === 'user' ? 'bg-blue-800 text-right' : 'bg-blue-500');
    bubble.textContent = text;

    if (who === 'system') {
      bubble.classList.add('text-sm', 'italic', 'opacity-90');
    }

    const avatar = createAvatar(who);

    if (role === 'user') {
      row.appendChild(bubble);
      row.appendChild(avatar);
    } else {
      row.appendChild(avatar);
      row.appendChild(bubble);
    }

    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  addMessage('system', '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! üëã‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô AI ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö  ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏≤‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ - ‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á ‡πÑ‡∏Ç‡πâ ‡∏´‡∏ß‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î ‡∏ß‡∏¥‡∏ï‡∏Å‡∏Å‡∏±‡∏á‡∏ß‡∏• ‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤ ‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û - ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏â‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏î‡πâ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÇ‡∏î‡∏¢‡∏î‡πà‡∏ß‡∏ô');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = msg.value.trim();
    if (!text) return;
    msg.value = '';
    err.classList.add('hidden');

    addMessage('user', text);

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();
      if (data && data.response) {
        addMessage('ai', data.response);
      } else {
        throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå "response"');
      }
    } catch (e) {
      err.textContent = `‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${e.message}`;
      err.classList.remove('hidden');
    }
  });
</script>
{% endblock %}
