{% extends "base.html" %}
{% block title %}แชทกับ AI - AI Health Analyze{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-4 text-center">แชทกับ AI</h2>

<div id="chat-shell" class="relative z-0 bg-white shadow rounded-xl p-4 max-w-4xl mx-auto w-full flex flex-col gap-3">
  <div id="chat" class="flex-1 overflow-y-auto border rounded p-3 bg-gray-50 flex flex-col gap-3"></div>

  <form id="chat-form" class="flex items-center gap-3">
    <!-- บังคับขนาดให้ชนะ CSS อื่น ๆ -->
    <input id="msg"
           type="text"
           class="flex-1 w-full min-w-0 h-11 border rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
           placeholder="พิมพ์ข้อความ...">
    <button type="submit"
            class="h-11 px-6 bg-blue-600 text-white rounded hover:bg-blue-700">
      ส่ง
    </button>
  </form>

  <p id="err" class="text-red-600 mt-2 hidden"></p>
</div>

<style>
  /* Resize chat container to follow viewport height */
  #chat-shell {
    height: clamp(24rem, calc(100vh - 13rem), 48rem);
  }

  @media (max-width: 640px) {
    #chat-shell {
      height: clamp(22rem, calc(100vh - 9rem), 40rem);
    }
  }

  #chat {
    flex: 1 1 auto;
    min-height: 16rem;
  }

  /* กัน CSS ภายนอกมาทับ input หน้านี้ */
  #chat-form input#msg {
    width: 100% !important;
    height: 44px !important;
  }
</style>

<script>
  const chat = document.getElementById('chat');
  const form = document.getElementById('chat-form');
  const msg  = document.getElementById('msg');
  const err  = document.getElementById('err');

  const avatars = {
    user: "{{ url_for('static', filename='img/avatar-user.svg') }}",
    ai: "{{ url_for('static', filename='img/avatar-ai.svg') }}",
    system: "{{ url_for('static', filename='img/avatar-ai.svg') }}"
  };

  function createAvatar(who) {
    const wrap = document.createElement('div');
    wrap.className = 'w-10 h-10 rounded-full border-2 border-blue-500 overflow-hidden flex-shrink-0 bg-white flex items-center justify-center';

    const role = who === 'system' ? 'ai' : who;
    const img = document.createElement('img');
    img.src = avatars[who] || avatars[role] || avatars.ai;
    img.alt = role === 'user' ? 'User avatar' : 'AI avatar';
    img.className = 'w-full h-full object-cover';
    img.onerror = () => {
      wrap.innerHTML = '';
      wrap.classList.add('text-blue-600', 'font-semibold');
      wrap.textContent = role === 'user' ? 'U' : 'AI';
      wrap.style.backgroundColor = role === 'user' ? '#1E3A8A' : '#2563EB';
    };

    wrap.appendChild(img);
    return wrap;
  }

  function addMessage(who, text) {
    const role = who === 'system' ? 'ai' : who;

    const row = document.createElement('div');
    row.className = 'w-full flex items-end gap-3';
    row.classList.add(role === 'user' ? 'justify-end' : 'justify-start');

    const bubble = document.createElement('div');
    bubble.className = 'px-4 py-2 rounded-2xl shadow max-w-[70%] whitespace-pre-wrap leading-relaxed text-white ' +
      (role === 'user' ? 'bg-blue-800 text-right' : 'bg-blue-500');
    bubble.textContent = text;

    if (who === 'system') {
      bubble.classList.add('text-sm', 'italic', 'opacity-90');
    }

    const avatar = createAvatar(who);

    if (role === 'user') {
      row.appendChild(bubble);
      row.appendChild(avatar);
    } else {
      row.appendChild(avatar);
      row.appendChild(bubble);
    }

    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  addMessage('system', 'สวัสดีค่ะ! ฉันเป็น AI แพทย์ดิจิทัล ที่พร้อมให้คำปรึกษาและช่วยเหลือคุณเกี่ยวกับ  อาการป่วยทางร่างกาย - ปวดหัว ปวดท้อง ไข้ หวัด และอาการต่างๆ สุขภาพจิต - ความเครียด วิตกกังวล ซึมเศร้า นอนไม่หลับ คำแนะนำการดูแลสุขภาพ - การป้องกันโรค การออกกำลังกาย อาหารการกินหมายเหตุสำคัญ: ฉันให้ข้อมูลเพื่อการศึกษาเท่านั้น ไม่สามารถทดแทนการตรวจรักษาจากแพทย์ได้ หากมีอาการรุนแรงควรพบแพทย์โดยด่วน');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = msg.value.trim();
    if (!text) return;
    msg.value = '';
    err.classList.add('hidden');

    addMessage('user', text);

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();
      if (data && data.response) {
        addMessage('ai', data.response);
      } else {
        throw new Error('ไม่มีฟิลด์ "response"');
      }
    } catch (e) {
      err.textContent = `ส่งไม่สำเร็จ: ${e.message}`;
      err.classList.remove('hidden');
    }
  });
</script>
{% endblock %}
